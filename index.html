
# Initialize event log source
$EventSource = "DriveMapper"
if (-not [System.Diagnostics.EventLog]::SourceExists($EventSource)) {
    try {
        New-EventLog -LogName Application -Source $EventSource -ErrorAction Stop
    } catch {
        Write-Host "Failed to create event source: $_"
    }
}
Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1000 -Message "Intune drive mapping script started."

# Check if running in SYSTEM context
$currentUser = [System.Security.Principal.WindowsIdentity]::GetCurrent().Name
if ($currentUser -eq "NT AUTHORITY\SYSTEM") {
    try {
        # Create the DriveMapper directory if it doesn't exist
        $scriptDir = "C:\ProgramData\DriveMapper"
        if (-not (Test-Path $scriptDir)) {
            New-Item -Path $scriptDir -ItemType Directory -Force | Out-Null
            # Set permissions to SYSTEM and Administrators only
            $acl = Get-Acl $scriptDir
            $acl.SetAccessRuleProtection($true, $false)
            $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("NT AUTHORITY\SYSTEM", "FullControl", "ContainerInherit, ObjectInherit", "None", "Allow")
            $acl.AddAccessRule($rule)
            $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Administrators", "FullControl", "ContainerInherit, ObjectInherit", "None", "Allow")
            $acl.AddAccessRule($rule)
            Set-Acl $scriptDir $acl
            Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1001 -Message "Created DriveMapper directory at $scriptDir"
        } else {
            Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1002 -Message "DriveMapper directory already exists at $scriptDir"
        }

        # Save the Base64-encoded drive mapping script to C:\ProgramData\DriveMapper\DriveMap.ps1
        $base64Script = "CiMgRGVmaW5lIGV2ZW50IGxvZyBzb3VyY2UKJEV2ZW50U291cmNlID0gIkRyaXZlTWFwcGVyIgpXcml0ZS1FdmVudExvZyAtTG9nTmFtZSBBcHBsaWNhdGlvbiAtU291cmNlICRFdmVudFNvdXJjZSAtRW50cnlUeXBlIEluZm9ybWF0aW9uIC1FdmVudElkIDIwMDAgLU1lc3NhZ2UgIkRyaXZlIG1hcHBpbmcgc2NyaXB0IHN0YXJ0ZWQuIgoKIyBSZW1vdmUgYWxsIGV4aXN0aW5nIGRyaXZlIG1hcHBpbmdzIGlmIHNwZWNpZmllZAoKdHJ5IHsKICAgIEdldC1QU0RyaXZlIC1QU1Byb3ZpZGVyIEZpbGVTeXN0ZW0gfCBXaGVyZS1PYmplY3QgeyAkXy5EaXNwbGF5Um9vdCAtbGlrZSAnXFwqJyB9IHwgRm9yRWFjaC1PYmplY3QgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIFJlbW92ZS1QU0RyaXZlIC1OYW1lICRfLk5hbWUgLUZvcmNlIC1FcnJvckFjdGlvbiBTdG9wCiAgICAgICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgSW5mb3JtYXRpb24gLUV2ZW50SWQgMjAwMSAtTWVzc2FnZSAiUmVtb3ZlZCBleGlzdGluZyBkcml2ZSBtYXBwaW5nOiAkKCRfLk5hbWUpIgogICAgICAgICAgICBXcml0ZS1Ib3N0ICJSZW1vdmVkIGV4aXN0aW5nIGRyaXZlIG1hcHBpbmc6ICQoJF8uTmFtZSkiCiAgICAgICAgfQogICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgV3JpdGUtRXZlbnRMb2cgLUxvZ05hbWUgQXBwbGljYXRpb24gLVNvdXJjZSAkRXZlbnRTb3VyY2UgLUVudHJ5VHlwZSBFcnJvciAtRXZlbnRJZCAyMDAyIC1NZXNzYWdlICJGYWlsZWQgdG8gcmVtb3ZlIGRyaXZlICQoJF8uTmFtZSk6ICRfIgogICAgICAgICAgICBXcml0ZS1Ib3N0ICJGYWlsZWQgdG8gcmVtb3ZlIGRyaXZlICQoJF8uTmFtZSk6ICRfIgogICAgICAgIH0KICAgIH0KfQpjYXRjaCB7CiAgICBXcml0ZS1FdmVudExvZyAtTG9nTmFtZSBBcHBsaWNhdGlvbiAtU291cmNlICRFdmVudFNvdXJjZSAtRW50cnlUeXBlIEVycm9yIC1FdmVudElkIDIwMDMgLU1lc3NhZ2UgIkVycm9yIHJlbW92aW5nIGV4aXN0aW5nIGRyaXZlIG1hcHBpbmdzOiAkXyIKICAgIFdyaXRlLUhvc3QgIkVycm9yIHJlbW92aW5nIGV4aXN0aW5nIGRyaXZlIG1hcHBpbmdzOiAkXyIKfQojIERlZmluZSBtYXBwaW5ncwokbWFwcGluZ3MgPSBAKAogICAgQHsgRHJpdmVMZXR0ZXIgPSAiRyI7IE5ldHdvcmtQYXRoID0gIlxcMTkyLjE2OC4xMDEuMjUwXGdzcG90IjsgR3JvdXBOYW1lID0gIkRvbWFpbiBVc2VycyI7IFByb2ZpbGVOYW1lID0gIkRvbWFpbkF1dGhlbnRpY2F0ZWQiOyBEb21haW5TdWZmaXggPSAiIiB9CikKCmZvcmVhY2ggKCRtYXBwaW5nIGluICRtYXBwaW5ncykgewogICAgV3JpdGUtRXZlbnRMb2cgLUxvZ05hbWUgQXBwbGljYXRpb24gLVNvdXJjZSAkRXZlbnRTb3VyY2UgLUVudHJ5VHlwZSBJbmZvcm1hdGlvbiAtRXZlbnRJZCAyMDA0IC1NZXNzYWdlICJQcm9jZXNzaW5nIGRyaXZlIG1hcHBpbmcgZm9yICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpOiB0byAkKCRtYXBwaW5nLk5ldHdvcmtQYXRoKSIKCiAgICAjIFZhbGlkYXRlIG5ldHdvcmsgcGF0aCBhY2Nlc3NpYmlsaXR5CiAgICBpZiAoLW5vdCAoVGVzdC1QYXRoICRtYXBwaW5nLk5ldHdvcmtQYXRoKSkgewogICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgV2FybmluZyAtRXZlbnRJZCAyMDA1IC1NZXNzYWdlICJOZXR3b3JrIHBhdGggJCgkbWFwcGluZy5OZXR3b3JrUGF0aCkgaXMgaW5hY2Nlc3NpYmxlLiBEcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTogbm90IG1hcHBlZC4iCiAgICAgICAgV3JpdGUtSG9zdCAiTmV0d29yayBwYXRoICQoJG1hcHBpbmcuTmV0d29ya1BhdGgpIGlzIGluYWNjZXNzaWJsZS4gRHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6IG5vdCBtYXBwZWQuIgogICAgICAgIGNvbnRpbnVlCiAgICB9CgogICAgIyBDaGVjayBpZiB0aGUgbmV0d29yayBwcm9maWxlIG1hdGNoZXMgdGhlIHNwZWNpZmllZCBwcm9maWxlCiAgICAkbmV0d29ya1Byb2ZpbGVzID0gKEdldC1OZXRDb25uZWN0aW9uUHJvZmlsZSkuTmV0d29ya0NhdGVnb3J5CiAgICBpZiAoJG5ldHdvcmtQcm9maWxlcyAtY29udGFpbnMgJG1hcHBpbmcuUHJvZmlsZU5hbWUpIHsKICAgICAgICAjIENoZWNrIGRvbWFpbiBzdWZmaXggaWYgc3BlY2lmaWVkCiAgICAgICAgJGRvbWFpbk1hdGNoID0gaWYgKCRtYXBwaW5nLkRvbWFpblN1ZmZpeCkgewogICAgICAgICAgICAkYWRhcHRlcnMgPSBHZXQtTmV0QWRhcHRlciB8IFdoZXJlLU9iamVjdCB7ICRfLlN0YXR1cyAtZXEgJ1VwJyB9CiAgICAgICAgICAgICRtYXRjaEZvdW5kID0gJGZhbHNlCiAgICAgICAgICAgIGZvcmVhY2ggKCRhZGFwdGVyIGluICRhZGFwdGVycykgewogICAgICAgICAgICAgICAgJGRuc0NvbmZpZyA9IEdldC1EbnNDbGllbnQgfCBXaGVyZS1PYmplY3QgeyAkXy5JbnRlcmZhY2VJbmRleCAtZXEgJGFkYXB0ZXIuSW50ZXJmYWNlSW5kZXggfQogICAgICAgICAgICAgICAgaWYgKCRkbnNDb25maWcgLWFuZCAkZG5zQ29uZmlnLkNvbm5lY3Rpb25TcGVjaWZpY1N1ZmZpeCAtZXEgJG1hcHBpbmcuRG9tYWluU3VmZml4KSB7CiAgICAgICAgICAgICAgICAgICAgJG1hdGNoRm91bmQgPSAkdHJ1ZQogICAgICAgICAgICAgICAgICAgIGJyZWFrCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgJG1hdGNoRm91bmQKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAkdHJ1ZQogICAgICAgIH0KCiAgICAgICAgaWYgKCRkb21haW5NYXRjaCkgewogICAgICAgICAgICAjIEdldCB0aGUgY3VycmVudCB1c2VyJ3MgZG9tYWluIGFuZCBTSUQKICAgICAgICAgICAgJGN1cnJlbnRVc2VyID0gW1N5c3RlbS5TZWN1cml0eS5QcmluY2lwYWwuV2luZG93c0lkZW50aXR5XTo6R2V0Q3VycmVudCgpCiAgICAgICAgICAgICR1c2VyTmFtZSA9ICRjdXJyZW50VXNlci5OYW1lCiAgICAgICAgICAgICRkb21haW4gPSAkdXNlck5hbWUuU3BsaXQoJ1wnKVswXQogICAgICAgICAgICAkdXNlclNpZCA9ICRjdXJyZW50VXNlci5Vc2VyLlZhbHVlCgogICAgICAgICAgICAjIENoZWNrIGlmIHRoZSBtYWNoaW5lIGlzIGRvbWFpbi1qb2luZWQKICAgICAgICAgICAgJGlzRG9tYWluSm9pbmVkID0gKEdldC1XbWlPYmplY3QgLUNsYXNzIFdpbjMyX0NvbXB1dGVyU3lzdGVtKS5QYXJ0T2ZEb21haW4KCiAgICAgICAgICAgICMgQ2hlY2sgaWYgdGhlIHVzZXIgaXMgYSBtZW1iZXIgb2YgdGhlIHNwZWNpZmllZCBncm91cAogICAgICAgICAgICAkZ3JvdXAgPSAkbWFwcGluZy5Hcm91cE5hbWUKICAgICAgICAgICAgJGlzTWVtYmVyID0gJGZhbHNlCiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAjIElmIG5vdCBkb21haW4tam9pbmVkIGFuZCBncm91cCBpcyBhIGRvbWFpbiBncm91cCwgc2tpcCBtZW1iZXJzaGlwIGNoZWNrCiAgICAgICAgICAgICAgICBpZiAoLW5vdCAkaXNEb21haW5Kb2luZWQgLWFuZCAkZ3JvdXAgLWVxICdEb21haW4gVXNlcnMnKSB7CiAgICAgICAgICAgICAgICAgICAgV3JpdGUtRXZlbnRMb2cgLUxvZ05hbWUgQXBwbGljYXRpb24gLVNvdXJjZSAkRXZlbnRTb3VyY2UgLUVudHJ5VHlwZSBXYXJuaW5nIC1FdmVudElkIDIwMDYgLU1lc3NhZ2UgIk1hY2hpbmUgaXMgbm90IGRvbWFpbi1qb2luZWQuIENhbm5vdCBiZSBhIG1lbWJlciBvZiAnJGdyb3VwJy4gRHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6IG5vdCBtYXBwZWQuIgogICAgICAgICAgICAgICAgICAgIFdyaXRlLUhvc3QgIk1hY2hpbmUgaXMgbm90IGRvbWFpbi1qb2luZWQuIENhbm5vdCBiZSBhIG1lbWJlciBvZiAnJGdyb3VwJy4gRHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6IG5vdCBtYXBwZWQuIgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgIyBRdWVyeSB0aGUgZ3JvdXAgKGxvY2FsIG9yIGRvbWFpbikgdXNpbmcgV2luMzJfR3JvdXAKICAgICAgICAgICAgICAgICRncm91cE9iaiA9IEdldC1XbWlPYmplY3QgLUNsYXNzIFdpbjMyX0dyb3VwIC1GaWx0ZXIgIk5hbWU9JyRncm91cCcgQU5EIChEb21haW49JyRkb21haW4nIE9SIERvbWFpbj0nJGVudjpDT01QVVRFUk5BTUUnKSIKICAgICAgICAgICAgICAgIGlmICgkZ3JvdXBPYmopIHsKICAgICAgICAgICAgICAgICAgICAjIFF1ZXJ5IFdpbjMyX0dyb3VwVXNlciB0byBjaGVjayBpZiB0aGUgdXNlciBpcyBhIG1lbWJlcgogICAgICAgICAgICAgICAgICAgICRncm91cFNpZCA9ICRncm91cE9iai5TSUQKICAgICAgICAgICAgICAgICAgICAkbWVtYmVyc2hpcCA9IEdldC1XbWlPYmplY3QgLUNsYXNzIFdpbjMyX0dyb3VwVXNlciAtRmlsdGVyICJHcm91cENvbXBvbmVudD1cIldpbjMyX0dyb3VwLlNJRD0nJGdyb3VwU2lkJ1wiIgogICAgICAgICAgICAgICAgICAgIGlmICgkbWVtYmVyc2hpcCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkbWVtYmVyIGluICRtZW1iZXJzaGlwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoJG1lbWJlci5QYXJ0Q29tcG9uZW50IC1tYXRjaCAiV2luMzJfVXNlckFjY291bnQuU0lEPSckdXNlclNpZCciKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGlzTWVtYmVyID0gJHRydWUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBXcml0ZS1FdmVudExvZyAtTG9nTmFtZSBBcHBsaWNhdGlvbiAtU291cmNlICRFdmVudFNvdXJjZSAtRW50cnlUeXBlIFdhcm5pbmcgLUV2ZW50SWQgMjAwNiAtTWVzc2FnZSAiR3JvdXAgJyRncm91cCcgbm90IGZvdW5kLiBEcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTogbm90IG1hcHBlZC4iCiAgICAgICAgICAgICAgICAgICAgV3JpdGUtSG9zdCAiR3JvdXAgJyRncm91cCcgbm90IGZvdW5kLiBEcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTogbm90IG1hcHBlZC4iCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgSW5mb3JtYXRpb24gLUV2ZW50SWQgMjAwNiAtTWVzc2FnZSAiVXNlciBncm91cCBtZW1iZXJzaGlwIGNoZWNrIGZvciAnJGdyb3VwJzogJChpZiAoJGlzTWVtYmVyKSB7ICdNZW1iZXInIH0gZWxzZSB7ICdOb3QgYSBtZW1iZXInIH0pIgogICAgICAgICAgICB9CiAgICAgICAgICAgIGNhdGNoIHsKICAgICAgICAgICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgRXJyb3IgLUV2ZW50SWQgMjAwNyAtTWVzc2FnZSAiRXJyb3IgY2hlY2tpbmcgZ3JvdXAgbWVtYmVyc2hpcCBmb3IgJyRncm91cCc6ICRfIgogICAgICAgICAgICAgICAgV3JpdGUtSG9zdCAiRXJyb3IgY2hlY2tpbmcgZ3JvdXAgbWVtYmVyc2hpcCBmb3IgJyRncm91cCc6ICRfIgogICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYgKCRpc01lbWJlcikgewogICAgICAgICAgICAgICAgIyBDaGVjayBmb3IgZXhpc3RpbmcgZHJpdmUgbWFwcGluZyBhbmQgdW5tYXAgaWYgbmVjZXNzYXJ5CiAgICAgICAgICAgICAgICBpZiAoR2V0LVBTRHJpdmUgLU5hbWUgJG1hcHBpbmcuRHJpdmVMZXR0ZXIgLUVycm9yQWN0aW9uIFNpbGVudGx5Q29udGludWUpIHsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICBSZW1vdmUtUFNEcml2ZSAtTmFtZSAkbWFwcGluZy5Ecml2ZUxldHRlciAtRm9yY2UgLUVycm9yQWN0aW9uIFN0b3AKICAgICAgICAgICAgICAgICAgICAgICAgV3JpdGUtRXZlbnRMb2cgLUxvZ05hbWUgQXBwbGljYXRpb24gLVNvdXJjZSAkRXZlbnRTb3VyY2UgLUVudHJ5VHlwZSBJbmZvcm1hdGlvbiAtRXZlbnRJZCAyMDA4IC1NZXNzYWdlICJSZW1vdmVkIGNvbmZsaWN0aW5nIGRyaXZlIG1hcHBpbmc6ICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpIgogICAgICAgICAgICAgICAgICAgICAgICBXcml0ZS1Ib3N0ICJSZW1vdmVkIGNvbmZsaWN0aW5nIGRyaXZlIG1hcHBpbmc6ICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpIgogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjYXRjaCB7CiAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgRXJyb3IgLUV2ZW50SWQgMjAwOSAtTWVzc2FnZSAiRmFpbGVkIHRvIHJlbW92ZSBjb25mbGljdGluZyBkcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTogJF8iCiAgICAgICAgICAgICAgICAgICAgICAgIFdyaXRlLUhvc3QgIkZhaWxlZCB0byByZW1vdmUgY29uZmxpY3RpbmcgZHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6ICRfIgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAjIE1hcCB0aGUgZHJpdmUgdG8gdGhlIHNwZWNpZmllZCBuZXR3b3JrIHNoYXJlCiAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgIE5ldy1QU0RyaXZlIC1OYW1lICRtYXBwaW5nLkRyaXZlTGV0dGVyIC1QU1Byb3ZpZGVyIEZpbGVTeXN0ZW0gLVJvb3QgJG1hcHBpbmcuTmV0d29ya1BhdGggLVBlcnNpc3QgLUVycm9yQWN0aW9uIFN0b3AKICAgICAgICAgICAgICAgICAgICBXcml0ZS1FdmVudExvZyAtTG9nTmFtZSBBcHBsaWNhdGlvbiAtU291cmNlICRFdmVudFNvdXJjZSAtRW50cnlUeXBlIEluZm9ybWF0aW9uIC1FdmVudElkIDIwMTAgLU1lc3NhZ2UgIkRyaXZlICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpOiBtYXBwZWQgc3VjY2Vzc2Z1bGx5IHRvICQoJG1hcHBpbmcuTmV0d29ya1BhdGgpIgogICAgICAgICAgICAgICAgICAgIFdyaXRlLUhvc3QgIkRyaXZlICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpOiBtYXBwZWQgc3VjY2Vzc2Z1bGx5IHRvICQoJG1hcHBpbmcuTmV0d29ya1BhdGgpIgogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2F0Y2ggewogICAgICAgICAgICAgICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgRXJyb3IgLUV2ZW50SWQgMjAxMSAtTWVzc2FnZSAiRmFpbGVkIHRvIG1hcCBkcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTogJF8iCiAgICAgICAgICAgICAgICAgICAgV3JpdGUtSG9zdCAiRmFpbGVkIHRvIG1hcCBkcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTouIEVycm9yOiAkXyIKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgV2FybmluZyAtRXZlbnRJZCAyMDEyIC1NZXNzYWdlICJVc2VyIGlzIG5vdCBhIG1lbWJlciBvZiAnJGdyb3VwJy4gRHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6IG5vdCBtYXBwZWQuIgogICAgICAgICAgICAgICAgV3JpdGUtSG9zdCAiVXNlciBpcyBub3QgYSBtZW1iZXIgb2YgJyRncm91cCcuIERyaXZlICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpOiBub3QgbWFwcGVkLiIKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBlbHNlIHsKICAgICAgICAgICAgV3JpdGUtRXZlbnRMb2cgLUxvZ05hbWUgQXBwbGljYXRpb24gLVNvdXJjZSAkRXZlbnRTb3VyY2UgLUVudHJ5VHlwZSBXYXJuaW5nIC1FdmVudElkIDIwMTMgLU1lc3NhZ2UgIkRvbWFpbiBzdWZmaXggZG9lcyBub3QgbWF0Y2ggJyQoJG1hcHBpbmcuRG9tYWluU3VmZml4KScuIERyaXZlICQoJG1hcHBpbmcuRHJpdmVMZXR0ZXIpOiBub3QgbWFwcGVkLiIKICAgICAgICAgICAgV3JpdGUtSG9zdCAiRG9tYWluIHN1ZmZpeCBkb2VzIG5vdCBtYXRjaCAnJCgkbWFwcGluZy5Eb21haW5TdWZmaXgpJy4gRHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6IG5vdCBtYXBwZWQuIgogICAgICAgIH0KICAgIH0KICAgIGVsc2UgewogICAgICAgIFdyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgV2FybmluZyAtRXZlbnRJZCAyMDE0IC1NZXNzYWdlICJOZXR3b3JrIHByb2ZpbGUgaXMgbm90ICQoJG1hcHBpbmcuUHJvZmlsZU5hbWUpLiBEcml2ZSAkKCRtYXBwaW5nLkRyaXZlTGV0dGVyKTogbm90IG1hcHBlZC4iCiAgICAgICAgV3JpdGUtSG9zdCAiTmV0d29yayBwcm9maWxlIGlzIG5vdCAkKCRtYXBwaW5nLlByb2ZpbGVOYW1lKS4gRHJpdmUgJCgkbWFwcGluZy5Ecml2ZUxldHRlcik6IG5vdCBtYXBwZWQuIgogICAgfQp9CldyaXRlLUV2ZW50TG9nIC1Mb2dOYW1lIEFwcGxpY2F0aW9uIC1Tb3VyY2UgJEV2ZW50U291cmNlIC1FbnRyeVR5cGUgSW5mb3JtYXRpb24gLUV2ZW50SWQgMjAxNSAtTWVzc2FnZSAiRHJpdmUgbWFwcGluZyBzY3JpcHQgY29tcGxldGVkLiIK"
        $scriptBytes = [System.Convert]::FromBase64String($base64Script)
        $scriptContent = [System.Text.Encoding]::UTF8.GetString($scriptBytes)
        $scriptPath = "$scriptDir\DriveMap.ps1"
        [System.IO.File]::WriteAllText($scriptPath, $scriptContent)
        # Set file permissions to SYSTEM, Administrators, and Users
        $acl = Get-Acl $scriptPath
        $acl.SetAccessRuleProtection($true, $false)
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("NT AUTHORITY\SYSTEM", "FullControl", "Allow")
        $acl.AddAccessRule($rule)
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Administrators", "FullControl", "Allow")
        $acl.AddAccessRule($rule)
        $rule = New-Object System.Security.AccessControl.FileSystemAccessRule("Users", "ReadAndExecute", "Allow")
        $acl.AddAccessRule($rule)
        Set-Acl $scriptPath $acl
        Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1003 -Message "Drive mapping script saved to $scriptPath"
        Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1008 -Message "Granted ReadAndExecute permissions to Users for $scriptPath"

        # Create a scheduled task to run the drive mapping script at user logon
        $taskName = "DriveMappingTask"
        $taskDescription = "Runs drive mapping script at user logon"
        $action = New-ScheduledTaskAction -Execute "PowerShell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -File 'C:\ProgramData\DriveMapper\DriveMap.ps1'"
        $trigger = New-ScheduledTaskTrigger -AtLogOn
        $principal = New-ScheduledTaskPrincipal -GroupId "Users" -RunLevel Limited
        $settings = New-ScheduledTaskSettingsSet -AllowStartIfOnBatteries -DontStopIfGoingOnBatteries -StartWhenAvailable

        # Register the scheduled task
        Register-ScheduledTask -TaskName $taskName -Description $taskDescription -Action $action -Trigger $trigger -Principal $principal -Settings $settings -Force
        Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1004 -Message "Scheduled task '$taskName' created successfully"
        Write-Host "Scheduled task '$taskName' created successfully"
    }
    catch {
        Write-EventLog -LogName Application -Source $EventSource -EntryType Error -EventId 1005 -Message "Error setting up drive mapping task: $_"
        Write-Error "Error setting up drive mapping task: $_"
        exit 1
    }
}
else {
    Write-EventLog -LogName Application -Source $EventSource -EntryType Error -EventId 1006 -Message "Script not running in SYSTEM context. Please deploy via Intune with SYSTEM context."
    Write-Host "Script not running in SYSTEM context. Please deploy via Intune with SYSTEM context."
}
Write-EventLog -LogName Application -Source $EventSource -EntryType Information -EventId 1007 -Message "Intune drive mapping script completed."
